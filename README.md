# A Generative and Mutational Approach for Synthesizing Bug-exposing Test Cases to Guide Compiler Fuzzing

COMFUZZ is a compiler fuzzing framework that combining generative and mutation techniques. Unlike prior work, COMFUZZ devotes to generating the bug-exposing test cases by using historical test programs, and performs the focused testing by leveraging carefully designed bug-guided mutators.


## Docker Image

We provide a [Docker image](https://zenodo.org/record/7602317) to run "out of box". The docker image was tested on a host machine running Ubuntu 18.04.
The docker image contains the following scripts for running COMFUZZ:

* [step1_generator.py](): the script that generates test programs according to historical test programs.
* [step2_init.py](): the script that builds the initial seed pool.
* [step3_harness.py](): the script that performs the differential testing on target compilers.
* [step4_mutation.py](): the script that mutates the interesting test cases for focused and intensive testing.

You can use the following step-by-step instructions to run COMFUZZ:

## Setup
### 1.1 Load the Docker Image
0.Pre-setting

```
export DOCKER_CLIENT_TIMEOUT=500
export COMPOSE_HTTP_TIMEOUT=500
```

1.Download the whole project.

```
git clone https://github.com/NWU-NISL-Fuzzing/COMFUZZ.git

git submodule update --init --recursive
```

2.Run the docker-compose.yml.

```
docker-compose up -d
```

3.Enter into code docker.

```
docker exec -it comfuzz_container /bin/bash
```

### 1.2 Basic tools for COMFUZZ_Java

1.A zip file of JVM engines are stored in `/root`, you can unzip the engines, this step will spend about 60 min. If you want to use other versions of JVMs, save them in `/root/jvm`.

```
cd /root
unzip -q jvm_20230216.zip
```

2.The pre-trained model can be found in `$COMFUZZ_Java/data/model`, if the unzip process fail, please download from [this link](https://zenodo.org/record/7602317) again.

## Run

Here are two ways to run COMFUZZ: one automatically runs the whole procession, and another is to run step by step.

Some arguments are designed to specify some details in COMFUZZ, and you can use python `main.py --help` to know the meaning of arguments.

### 2.1 Run Automatically

Here is an instruction that can run COMFUZZ  automatically.

##### 2.1.1 COMFUZZ_JS

To facilitate testing, COMFUZZ provides quick-run command：

```
cd COMFUZZ_js/workline
python3 main.py
```

If you want to see how the overall process works：

```
python3 main.py --enrich_limit_num=10 --loop_times=5 --clean_project
```

For more details, you can use python3 main.py --help to see what this parameter means.

##### 2.1.2 COMFUZZ_Java

```
cd COMFUZZ_Java/workline
python main.py
```

 The argument `--clean_database` is helpful to clean the related tables in the database. The argument `--max_iterator` is used to specify the number of mutations. Here is an example to clean database and specify the mutation number as 2.

```
python main.py --clean_database=True --max_iterator=2
```

### 2.2 Run Step by Step

You can use the following step-by-step instructions to run COMFUZZ.

#### Step1. Generate test program

This step will generate JS functions or Java methods, and save them into `Table_Function`.

```
python step1_generator.py
```

Especially for COMFUZZ_Java, here are two ways to generate Java methods: short heads(`public class MyJVMTest` &`import java`) and heads from test suites(saved in  COMFUZZ_Java/workline/generate_tools/model_head.txt).
You can use special heads by running the following command:

```
python step1_generator.py --use_testsuits_head=True --testsuits_head_num=5 --temperature=0.5
```

Note that the arguments should obey file_num%testsuits_head_num==0.

#### Step2. Build the seed pool

This step will assemble JS functions or Java methods from `Table_Function`, and save them into `Table_Testcase`.

```
python step2_init.py
```

#### Step3. Differential testing

This step will apply the differential testing on the selected testcases, (1)origin testcases generated by the trained model, (2)mutated testcases marked as interesting, or (3)mutated testcases marked as not interesting.

```
python step3_harness.py
```

#### Step4. Mutation

This step will mutate testcases by two mutation methods: general-purpose mutation and bug-guided mutation.

```
python step4_mutation.py
```

## Main Results
The main results of our work is a [list of bugs](https://github.com/NWU-NISL-Fuzzing/COMFUZZ/blob/main/docs/Bug-List.md) exposed by COMFUZZ.
