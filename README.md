# A Generative and Mutational Approach for Synthesizing Bug-exposing Test Cases to Guide Compiler Fuzzing

COMFUZZ is a compiler fuzzing framework that combining generative and mutation techniques. Unlike prior work, COMFUZZ devotes to generating the bug-exposing test cases by using historical test programs, and performs the focused testing by leveraging carefully designed bug-guided mutators.


## Docker Image

We provide a [Docker image](https://zenodo.org/record/7602317) to [run "out of box"](#run). The docker image was tested on a host machine running Ubuntu 18.04.
We provide two ways to execute COMFUZZ: one is the [Quick Run](#1-quick-run); the other is to [Run Step-by-Step](#2-run-step-by-step) with the following scripts:

* [step1_generator.py](): the script that generates test programs according to historical test programs.
* [step2_init.py](): the script that builds the initial seed pool.
* [step3_harness.py](): the script that performs the differential testing on target compilers.
* [step4_mutation.py](): the script that mutates the interesting test cases for focused and intensive testing.


## Setup

### 1 Load the Docker Image

1.1 Using the following commands to setup the environment variables to aviod timeout:

```
export DOCKER_CLIENT_TIMEOUT=500
export COMPOSE_HTTP_TIMEOUT=500
```

1.2 Using the following command to run the ```./docker-compose.yml``` for starting the docker image .

```
docker-compose up -d
```

1.3 Run the following command to import docker container.

```
docker exec -it comfuzz_container /bin/bash
```


### 2 Additional Preliminaries for Testing JVM Compilers
In order to save the importing time for the docker container, we compressed the configured JVM compilers and the pre-trained model. You can use the following instructions to decompress them and put them in the expected directories.

**2.1 Decompress the JVM compilers** 

The compressed file is named ```jvm_20230216.zip``` and save at the path ```/root```. You can use the following commands to decompress it (require around 60 minutes):

```
cd /root
unzip -q jvm_20230216.zip
```

In addition, you can add the JVM compilers that are expected to be tested to the path `/root/jvm`. 


**2.2 Decompress the pre-trained model** 

The pre-trained model are stored at `$COMFUZZ_Java/data/model`. Run the following commands to decompress it:

```
cd /root/COMFUZZ/COMFUZZ_Java/data/model
unzip -q checkpoint-400000.zip
```

## Run


### 1 Quick Run

##### 1.1 Testing JS Compilers

Use the following commands to test JS compilers:

```
cd COMFUZZ_js/workline
python3 main.py --enrich_limit_num=10 --loop_times=5 --clean_project
```

The parameter `enrich_limit_num` controls the number of tese cases in the seed pool (we set to 10 for demonstration)ï¼Œ `loop_times` controls the iterative number during testing, `clean_project` means cleaing the data in the database. We also provide many configurable parameters for customized execution. You can use `python3 main.py --help` to see what these parameters mean.


##### 1.2 Testing JVM Compilers
Use the following commands to test JVM compilers:

```
cd COMFUZZ_Java/workline
python main.py --clean_database=True --max_iterator=2
```

The parameter `--clean_database` controls if cleaing the data in the database, `--max_iterator` is used to specify the number of iteration testing.


### 2 Run Step-by-Step

You can also use the following step-by-step instructions to run COMFUZZ. **Note that the step-by-step instructions are the same for testing JS and JVM compilers.**

#### Step1. Generate Test Programs

This step will generate JS functions or Java methods, and save them into `Table_Function`.

```
python step1_generator.py
```

For JVM testing, there are two ways to generate Java methods: short heads(`public class MyJVMTest` &`import java`) and heads from test suites (saved in COMFUZZ_Java/workline/generate_tools/model_head.txt).
You can use special heads by running the following command:

```
python step1_generator.py --use_testsuits_head=True --testsuits_head_num=5 --temperature=0.5
```

Note that the arguments should meet the constrain: `file_num % testsuits_head_num == 0`.

#### Step2. Build the Seed Pool

This step will assemble JS functions or Java methods from `Table_Function`, and save them into `Table_Testcase`.

```
python step2_init.py
```

#### Step3. Differential Testing

This step will apply the differential testing on the selected testcases, (1)origin testcases generated by the trained model, (2)mutated testcases marked as interesting, or (3)mutated testcases marked as non-interesting.

```
python step3_harness.py
```

#### Step4. Mutation

This step will mutate testcases by two mutation methods: general-purpose mutation and bug-guided mutation.

```
python step4_mutation.py
```

## Main Results
The main results of our work is a [list of bugs](https://github.com/NWU-NISL-Fuzzing/COMFUZZ/blob/main/docs/Bug-List.md) exposed by COMFUZZ.
